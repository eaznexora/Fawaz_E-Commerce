<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-Out | Fawaz Fragrance</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baskervville:ital@0;1&display=swap" rel="stylesheet">
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        /* --- CORE STYLES --- */
        :root {
            --bg-cream: #F8F5F0; --text-dark-brown: #3E2B26; --bar-brown: #A68B6C;
            --box-beige: #F4EFE6; --btn-text: #FFFFFF;
            --nav-pill-dark: #BCA380; --nav-item-light: #DBCDBA;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--bg-cream); color: var(--text-dark-brown); font-family: 'Cambria', serif; padding-bottom: 40px; }

        /* --- HEADER --- */
        .checkout-header { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 20px 25px; margin-bottom: 10px; }
        .back-circle-btn { width: 40px; height: 40px; border-radius: 50%; background-color: #A68B6C; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; color: white; font-size: 20px; transition: transform 0.2s; }
        .back-circle-btn:hover { transform: scale(1.1); }
        .page-title { font-size: 24px; font-weight: 600; font-family: 'Baskervville', serif; text-align: center; }

        /* --- CONTAINER --- */
        .checkout-container { padding: 0 25px; max-width: 600px; margin: 0 auto; }

        /* --- ITEM LIST --- */
        .item-count-label { font-size: 20px; margin-bottom: 20px; font-family: 'Baskervville', serif; font-weight: 400; }
        .checkout-item { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .item-img { width: 80px; height: 80px; background-color: #D9D9D9; border-radius: 12px; object-fit: cover; }
        .item-details { flex: 1; }
        .item-name { font-weight: 700; font-size: 16px; margin-bottom: 4px; font-family: 'Baskervville', serif; }
        .item-tag { font-size: 12px; color: #888; margin-bottom: 4px; }
        .item-price { font-weight: 700; font-size: 16px; color: #3E2B26; }
        
        .qty-controls { display: flex; align-items: center; gap: 10px; }
        .qty-btn { width: 28px; height: 28px; border-radius: 50%; background-color: #A68B6C; color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; }
        .qty-number { font-weight: 600; font-size: 16px; min-width: 20px; text-align: center; }

        /* --- PRICING SECTION --- */
        .pricing-section { margin-top: 30px; margin-bottom: 30px; }
        .price-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; align-items: flex-end; }
        .price-label { font-weight: 600; font-family: 'Baskervville', serif; color: var(--text-dark-brown); }
        .price-value { color: #666; font-family: sans-serif; font-size: 14px; font-weight: 500; }
        .breakdown-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: #666; }
        .breakdown-name { opacity: 0.8; }
        .shipping-note { font-size: 12px; color: #A68B6C; font-style: italic; margin-bottom: 12px; display: block; text-align: right; }
        .discount-note { font-size: 13px; color: #27ae60; font-weight: 600; display: block; text-align: right; margin-top: 5px; }
        .dashed-line { border-bottom: 1px dashed #ccc; margin: 15px 0; }
        .total-label { font-weight: 700; font-size: 20px; font-family: 'Baskervville', serif; color: #3E2B26; }
        .total-value { font-weight: 700; font-size: 22px; color: #A68B6C; }

        /* --- ADDRESS CARD --- */
        .address-card { background-color: #fff; border: 1px solid #A68B6C; border-radius: 15px; padding: 15px; margin-bottom: 20px; display: none; }
        .addr-name { font-weight: 700; font-size: 16px; margin-bottom: 5px; color: var(--text-dark-brown); }
        .addr-text { font-size: 14px; color: #666; line-height: 1.5; }
        .change-addr-btn { color: #A68B6C; font-size: 12px; font-weight: 600; text-decoration: underline; background: none; border: none; cursor: pointer; padding: 0; margin-top: 10px; }

        /* --- ACTION BUTTONS --- */
        .action-buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .btn-outline { width: 100%; padding: 15px; border-radius: 30px; border: 1px solid #A68B6C; background: transparent; color: #A68B6C; font-weight: 600; font-family: 'Baskervville', serif; cursor: pointer; text-align: center; text-decoration: none; display: block; font-size: 16px; }
        .btn-filled { width: 100%; padding: 15px; border-radius: 30px; border: none; background: #A68B6C; color: white; font-weight: 600; font-family: 'Baskervville', serif; cursor: pointer; box-shadow: 0 4px 10px rgba(166, 139, 108, 0.3); font-size: 16px; }
        .btn-upi { width: 100%; padding: 15px; border-radius: 30px; border: none; background: #5f259f; color: white; font-weight: 600; font-family: 'Baskervville', serif; cursor: pointer; box-shadow: 0 4px 10px rgba(95, 37, 159, 0.3); font-size: 16px; display: none; }

        #emptyCartMsg { text-align: center; margin-top: 50px; color: #888; display: none; }

        /* --- CUSTOM MODAL STYLES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: all 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal-card {
            background-color: var(--bg-cream); width: 85%; max-width: 350px;
            border-radius: 20px; padding: 25px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); transform: scale(0.8); transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-card { transform: scale(1); }

        .modal-icon { width: 50px; height: 50px; margin-bottom: 15px; }
        .modal-title { font-family: 'Baskervville', serif; font-size: 22px; margin-bottom: 10px; color: var(--text-dark-brown); }
        .modal-text { font-size: 14px; color: #666; margin-bottom: 25px; line-height: 1.5; }
        
        .modal-actions { display: flex; flex-direction: column; gap: 10px; }
        .btn-confirm { background-color: #27ae60; color: white; padding: 12px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; }
        .btn-cancel { background-color: transparent; border: 1px solid #999; color: #666; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>

    <div class="checkout-header">
        <button class="back-circle-btn" onclick="history.back()">&#8592;</button>
        <div class="page-title">Check-Out</div>
        <div></div>
    </div>

    <div class="checkout-container">
        <div class="item-count-label" id="itemCountLabel">Item (0)</div>
        <div id="checkoutItemsList"></div>
        <div id="emptyCartMsg">Your cart is empty. <a href="collection.html">Shop Now</a></div>

        <div id="pricingSection" style="display: none;">
            <div class="price-row"><span class="price-label">Total Price:</span></div>
            <div id="priceBreakdownList"></div>
            <div class="dashed-line"></div>
            <div class="price-row" style="margin-bottom: 4px;">
                <span class="price-label">Delivery Fee:</span>
                <span class="price-value" id="deliveryFee">₹70</span>
            </div>
            <span class="shipping-note">(Free shipping above ₹599)</span>
            <div class="dashed-line"></div>
            <div class="price-row" style="align-items: center;">
                <span class="total-label">Total Amount:</span>
                <span class="total-value" id="grandTotal">₹0</span>
            </div>
            <span class="discount-note" id="discountNote"></span>
            <div class="dashed-line"></div>
            
            <div id="savedAddressCard" class="address-card">
                <div class="addr-name" id="dispName">User Name</div>
                <div class="addr-text" id="dispAddr">Address Line 1</div>
                <div class="addr-text" id="dispPhone">Phone</div>
                <button class="change-addr-btn" onclick="window.location.href='address.html'">Change Address</button>
            </div>

            <div class="action-buttons">
                <button id="mainActionBtn" class="btn-filled" onclick="handleMainAction()">Add Address</button>
                <button id="upiActionBtn" class="btn-upi" onclick="handleUPIPayment()">Pay via PhonePe/UPI</button>
                <button class="btn-outline" onclick="window.location.href='cart.html'">Cancel Order</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="paymentModal">
        <div class="modal-card">
            <div class="modal-title">Confirm Payment</div>
            <div class="modal-text">Did you complete the payment successfully in your UPI App?</div>
            <div class="modal-actions">
                <button class="btn-confirm" onclick="confirmPayment(true)">Yes, Payment Done</button>
                <button class="btn-cancel" onclick="confirmPayment(false)">No, Not Yet</button>
            </div>
        </div>
    </div>

    <script>
        const SHIPPING_COST = 75 ;
        const FREE_SHIPPING_THRESHOLD = 599;
        const DISCOUNT_PERCENTAGE = 0.125; 
        
        // --- YOUR KEYS ---
        const EMAILJS_PUBLIC_KEY = "z2glUWJ25FZ7vdql5"; 
        const EMAILJS_SERVICE_ID = "service_uvvzfip"; 
        const EMAILJS_TEMPLATE_ID = "template_itx2xxd"; 
        const MERCHANT_UPI_ID = "8928028780@fam"; 
        const MERCHANT_NAME = "FawazFragrance";

        let savedAddress = null;
        let currentTotalValue = 0;

        function formatCurrency(amount) { return "₹" + amount.toFixed(2); }

        function loadCheckout() {
            let cart = JSON.parse(localStorage.getItem('fawazCart')) || [];
            const list = document.getElementById('checkoutItemsList');
            const breakdownList = document.getElementById('priceBreakdownList');
            const countLabel = document.getElementById('itemCountLabel');
            const emptyMsg = document.getElementById('emptyCartMsg');
            const pricingSection = document.getElementById('pricingSection');
            
            const deliveryFeeEl = document.getElementById('deliveryFee');
            const grandTotalEl = document.getElementById('grandTotal');
            const discountNoteEl = document.getElementById('discountNote');

            list.innerHTML = '';
            breakdownList.innerHTML = '';

            const totalItemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            countLabel.innerText = `Item (${totalItemCount})`;

            if (cart.length === 0) {
                emptyMsg.style.display = 'block';
                pricingSection.style.display = 'none';
                return;
            } else {
                emptyMsg.style.display = 'none';
                pricingSection.style.display = 'block';
            }

            let subTotal = 0;

            cart.forEach((product, index) => {
                const row = document.createElement('div');
                row.classList.add('checkout-item');
                row.innerHTML = `
                    <img src="${product.img}" alt="${product.name}" class="item-img">
                    <div class="item-details">
                        <div class="item-name">${product.name}</div>
                        <div class="item-tag">${product.tagline || 'Fragrance'}</div>
                        <div class="item-price">₹${product.price}</div>
                    </div>
                    <div class="qty-controls">
                        <button class="qty-btn" onclick="updateQty(${index}, -1)">-</button>
                        <span class="qty-number">${product.quantity}</span>
                        <button class="qty-btn" onclick="updateQty(${index}, 1)">+</button>
                    </div>
                `;
                list.appendChild(row);

                const itemTotal = product.price * product.quantity;
                subTotal += itemTotal;

                const breakdownRow = document.createElement('div');
                breakdownRow.classList.add('breakdown-row');
                breakdownRow.innerHTML = `<span class="breakdown-name">${product.name} (x${product.quantity})</span><span>₹${itemTotal}</span>`;
                breakdownList.appendChild(breakdownRow);
            });

            let finalShipping = (subTotal > FREE_SHIPPING_THRESHOLD) ? 0 : SHIPPING_COST;
            const deliveryFeeElVal = document.getElementById('deliveryFee');
            if (finalShipping === 0) {
                deliveryFeeElVal.innerText = "Free";
                deliveryFeeElVal.style.color = "#27ae60";
            } else {
                deliveryFeeElVal.innerText = "₹" + SHIPPING_COST;
                deliveryFeeElVal.style.color = "#666";
            }

            const discountAmount = subTotal * DISCOUNT_PERCENTAGE;
            const discountedSubTotal = subTotal - discountAmount;
            
            currentTotalValue = discountedSubTotal + finalShipping;

            grandTotalEl.innerText = formatCurrency(currentTotalValue);
            discountNoteEl.innerText = `(Includes ${formatCurrency(discountAmount)} Discount @ 12.5%)`;
            
            checkAddress();
        }

        function updateQty(index, change) {
            let cart = JSON.parse(localStorage.getItem('fawazCart')) || [];
            cart[index].quantity += change;
            if (cart[index].quantity <= 0) cart.splice(index, 1);
            localStorage.setItem('fawazCart', JSON.stringify(cart));
            loadCheckout();
        }

        function checkAddress() {
            const storedAddr = localStorage.getItem('fawazAddress');
            const mainBtn = document.getElementById('mainActionBtn');
            const upiBtn = document.getElementById('upiActionBtn');
            const addrCard = document.getElementById('savedAddressCard');

            if (storedAddr) {
                savedAddress = JSON.parse(storedAddr);
                addrCard.style.display = 'block';
                document.getElementById('dispName').innerText = savedAddress.name;
                document.getElementById('dispAddr').innerText = `${savedAddress.line1}, ${savedAddress.line2}, ${savedAddress.city} - ${savedAddress.pincode}`;
                document.getElementById('dispPhone').innerText = `Phone: ${savedAddress.phone}`;

                mainBtn.innerText = "Place Order (COD)";
                mainBtn.style.backgroundColor = "#25D366"; 
                upiBtn.style.display = "block";
            } else {
                addrCard.style.display = 'none';
                mainBtn.innerText = "Add Address";
                mainBtn.style.backgroundColor = "#A68B6C"; 
                upiBtn.style.display = "none";
            }
        }

        function handleMainAction() {
            if (savedAddress) {
                placeOrderEmail("COD");
            } else {
                window.location.href = 'address.html';
            }
        }

        // --- CUSTOM MODAL LOGIC ---
        function handleUPIPayment() {
            if (!savedAddress) { alert("Please add an address first."); return; }
            
            // 1. Open UPI App
            const upiLink = `upi://pay?pa=${MERCHANT_UPI_ID}&pn=${MERCHANT_NAME}&am=${currentTotalValue.toFixed(2)}&cu=INR`;
            window.location.href = upiLink;
            
            // 2. Wait 3 seconds, then show the Styled Modal
            setTimeout(() => {
                document.getElementById('paymentModal').classList.add('active');
            }, 3000);
        }

        function confirmPayment(isSuccess) {
            // Hide Modal
            document.getElementById('paymentModal').classList.remove('active');
            
            if (isSuccess) {
                // If user clicked YES, send order email
                placeOrderEmail("PAID via UPI");
            }
        }

        function placeOrderEmail(paymentStatus) {
            emailjs.init(EMAILJS_PUBLIC_KEY);

            let cart = JSON.parse(localStorage.getItem('fawazCart')) || [];
            let itemListString = "";
            cart.forEach(item => { itemListString += `${item.name} (x${item.quantity}) - ₹${item.price * item.quantity}\n`; });

            const templateParams = {
                from_name: savedAddress.name,
                customer_email: savedAddress.email,
                customer_phone: savedAddress.phone,
                customer_address: `${savedAddress.line1}, ${savedAddress.line2}, ${savedAddress.city} - ${savedAddress.pincode}`,
                order_items: itemListString,
                order_total: document.getElementById('grandTotal').innerText,
                payment_status: paymentStatus
            };

            const btn = document.getElementById('mainActionBtn');
            const originalText = btn.innerText;
            btn.innerText = "Processing...";
            btn.disabled = true;

            emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
                .then(function(response) {
                    window.location.href = 'success.html';
                }, function(error) {
                    alert("Order failed to send. Error: " + JSON.stringify(error));
                    btn.innerText = originalText;
                    btn.disabled = false;
                });
        }

        document.addEventListener('DOMContentLoaded', loadCheckout);
    </script>
</body>
</html>


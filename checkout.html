<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-Out | Fawaz Fragrance</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baskervville:ital@0;1&display=swap" rel="stylesheet">
    
    <style>
        /* --- CORE STYLES --- */
        :root {
            --bg-cream: #F8F5F0; --text-dark-brown: #3E2B26; --bar-brown: #A68B6C;
            --box-beige: #F4EFE6; --btn-text: #FFFFFF;
            --nav-pill-dark: #BCA380; --nav-item-light: #DBCDBA;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--bg-cream); color: var(--text-dark-brown); font-family: 'Cambria', serif; padding-bottom: 40px; }

        /* --- HEADER --- */
        .checkout-header {
            display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;
            padding: 20px 25px; margin-bottom: 10px;
        }
        .back-circle-btn {
            width: 40px; height: 40px; border-radius: 50%; background-color: #A68B6C;
            display: flex; align-items: center; justify-content: center; cursor: pointer; border: none;
            color: white; font-size: 20px; transition: transform 0.2s;
        }
        .back-circle-btn:hover { transform: scale(1.1); }
        .page-title { font-size: 24px; font-weight: 600; font-family: 'Baskervville', serif; text-align: center; }

        /* --- CONTAINER --- */
        .checkout-container { padding: 0 25px; max-width: 600px; margin: 0 auto; }

        /* --- ITEM LIST SECTION --- */
        .item-count-label { font-size: 20px; margin-bottom: 20px; font-family: 'Baskervville', serif; font-weight: 400; }

        .checkout-item {
            display: flex; align-items: center; gap: 15px; margin-bottom: 20px;
        }
        .item-img {
            width: 80px; height: 80px; background-color: #D9D9D9; border-radius: 12px;
            object-fit: cover;
        }
        .item-details { flex: 1; }
        .item-name { font-weight: 700; font-size: 16px; margin-bottom: 4px; font-family: 'Baskervville', serif; }
        .item-tag { font-size: 12px; color: #888; margin-bottom: 4px; }
        .item-price { font-weight: 700; font-size: 16px; color: #3E2B26; }

        /* Quantity Controls */
        .qty-controls { display: flex; align-items: center; gap: 10px; }
        .qty-btn {
            width: 28px; height: 28px; border-radius: 50%; background-color: #A68B6C;
            color: white; border: none; display: flex; align-items: center; justify-content: center;
            font-size: 18px; cursor: pointer;
        }
        .qty-number { font-weight: 600; font-size: 16px; min-width: 20px; text-align: center; }

        /* --- PRICING SECTION --- */
        .pricing-section { margin-top: 30px; margin-bottom: 30px; }
        
        .price-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; align-items: flex-end; }
        .price-label { font-weight: 600; font-family: 'Baskervville', serif; color: var(--text-dark-brown); }
        .price-value { color: #666; font-family: sans-serif; font-size: 14px; font-weight: 500; }
        
        .breakdown-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: #666; }
        .breakdown-name { opacity: 0.8; }

        .shipping-note {
            font-size: 12px; color: #A68B6C; /* Brand color */
            font-style: italic; margin-bottom: 12px; display: block;
            text-align: right;
        }

        .discount-note {
            font-size: 13px; color: #27ae60; /* Green for success */
            font-weight: 600; display: block; text-align: right; margin-top: 5px;
        }

        .dashed-line { border-bottom: 1px dashed #ccc; margin: 15px 0; }

        .total-label { font-weight: 700; font-size: 20px; font-family: 'Baskervville', serif; color: #3E2B26; }
        .total-value { font-weight: 700; font-size: 22px; color: #A68B6C; }

        /* --- ADDRESS CARD --- */
        .address-card {
            background-color: #fff; border: 1px solid #A68B6C; border-radius: 15px;
            padding: 15px; margin-bottom: 20px; display: none;
        }
        .addr-name { font-weight: 700; font-size: 16px; margin-bottom: 5px; color: var(--text-dark-brown); }
        .addr-text { font-size: 14px; color: #666; line-height: 1.5; }
        .change-addr-btn {
            color: #A68B6C; font-size: 12px; font-weight: 600; text-decoration: underline;
            background: none; border: none; cursor: pointer; padding: 0; margin-top: 10px;
        }

        /* --- ACTION BUTTONS --- */
        .action-buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        
        .btn-outline {
            width: 100%; padding: 15px; border-radius: 30px; border: 1px solid #A68B6C;
            background: transparent; color: #A68B6C; font-weight: 600; font-family: 'Baskervville', serif;
            cursor: pointer; text-align: center; text-decoration: none; display: block; font-size: 16px;
        }
        .btn-filled {
            width: 100%; padding: 15px; border-radius: 30px; border: none;
            background: #A68B6C; color: white; font-weight: 600; font-family: 'Baskervville', serif;
            cursor: pointer; box-shadow: 0 4px 10px rgba(166, 139, 108, 0.3); font-size: 16px;
        }
        /* Pay Online Button Style */
        .btn-upi {
            width: 100%; padding: 15px; border-radius: 30px; border: none;
            background: #5f259f; /* PhonePe Purple */
            color: white; font-weight: 600; font-family: 'Baskervville', serif;
            cursor: pointer; box-shadow: 0 4px 10px rgba(95, 37, 159, 0.3); font-size: 16px;
            display: none; /* Hidden until address added */
        }

        #emptyCartMsg { text-align: center; margin-top: 50px; color: #888; display: none; }
    </style>
</head>
<body>

    <div class="checkout-header">
        <button class="back-circle-btn" onclick="history.back()">&#8592;</button>
        <div class="page-title">Check-Out</div>
        <div></div>
    </div>

    <div class="checkout-container">
        
        <div class="item-count-label" id="itemCountLabel">Item (0)</div>
        <div id="checkoutItemsList"></div>
        <div id="emptyCartMsg">Your cart is empty. <a href='collection.html'>Shop Now</a></div>

        <div id="pricingSection" style="display: none;">
            
            <div class="price-row"><span class="price-label">Total Price:</span></div>
            <div id="priceBreakdownList"></div>

            <div class="dashed-line"></div>

            <div class="price-row" style="margin-bottom: 4px;">
                <span class="price-label">Delivery Fee:</span>
                <span class="price-value" id="deliveryFee">₹70</span>
            </div>
            <span class="shipping-note">(Free shipping above ₹599)</span>

            <div class="dashed-line"></div>

            <div class="price-row" style="align-items: center;">
                <span class="total-label">Total Amount:</span>
                <span class="total-value" id="grandTotal">₹0</span>
            </div>
            <span class="discount-note" id="discountNote"></span>

            <div class="dashed-line"></div>
            <div id="savedAddressCard" class="address-card">
                <div class="addr-name" id="dispName">User Name</div>
                <div class="addr-text" id="dispAddr">Address Line 1</div>
                <div class="addr-text" id="dispPhone">Phone</div>
                <button class="change-addr-btn" onclick="window.location.href='address.html'">Change Address</button>
            </div>

            <div class="action-buttons">
                <button id="mainActionBtn" class="btn-filled" onclick="handleMainAction()">Add Address</button>
                
                <button id="upiActionBtn" class="btn-upi" onclick="handleUPIPayment()">Pay via PhonePe/UPI</button>

                <button class="btn-outline" onclick="window.location.href='cart.html'">Cancel Order</button>
            </div>

        </div>
    </div>

    <script>
        const SHIPPING_COST = 70;
        const FREE_SHIPPING_THRESHOLD = 599;
        const DISCOUNT_PERCENTAGE = 0.125; 
        
        // --- YOUR UPI ID HERE ---
        const MERCHANT_UPI_ID = "7208964926@fam"; // Replace with your actual UPI ID
        const MERCHANT_NAME = "FawazFragrance";

        let savedAddress = null;
        let currentTotalValue = 0; // Store the raw number

        function formatCurrency(amount) { return "₹" + amount.toFixed(2); }

        function loadCheckout() {
            let cart = JSON.parse(localStorage.getItem('fawazCart')) || [];
            const list = document.getElementById('checkoutItemsList');
            const breakdownList = document.getElementById('priceBreakdownList');
            const countLabel = document.getElementById('itemCountLabel');
            const emptyMsg = document.getElementById('emptyCartMsg');
            const pricingSection = document.getElementById('pricingSection');
            
            const deliveryFeeEl = document.getElementById('deliveryFee');
            const grandTotalEl = document.getElementById('grandTotal');
            const discountNoteEl = document.getElementById('discountNote');

            list.innerHTML = '';
            breakdownList.innerHTML = '';

            const totalItemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            countLabel.innerText = `Item (${totalItemCount})`;

            if (cart.length === 0) {
                emptyMsg.style.display = 'block';
                pricingSection.style.display = 'none';
                return;
            } else {
                emptyMsg.style.display = 'none';
                pricingSection.style.display = 'block';
            }

            let subTotal = 0;

            cart.forEach((product, index) => {
                const row = document.createElement('div');
                row.classList.add('checkout-item');
                row.innerHTML = `
                    <img src="${product.img}" alt="${product.name}" class="item-img">
                    <div class="item-details">
                        <div class="item-name">${product.name}</div>
                        <div class="item-tag">${product.tagline || 'Fragrance'}</div>
                        <div class="item-price">₹${product.price}</div>
                    </div>
                    <div class="qty-controls">
                        <button class="qty-btn" onclick="updateQty(${index}, -1)">-</button>
                        <span class="qty-number">${product.quantity}</span>
                        <button class="qty-btn" onclick="updateQty(${index}, 1)">+</button>
                    </div>
                `;
                list.appendChild(row);

                const itemTotal = product.price * product.quantity;
                subTotal += itemTotal;

                const breakdownRow = document.createElement('div');
                breakdownRow.classList.add('breakdown-row');
                breakdownRow.innerHTML = `<span class="breakdown-name">${product.name} (x${product.quantity})</span><span>₹${itemTotal}</span>`;
                breakdownList.appendChild(breakdownRow);
            });

            let finalShipping = (subTotal > FREE_SHIPPING_THRESHOLD) ? 0 : SHIPPING_COST;
            const deliveryFeeElVal = document.getElementById('deliveryFee');
            if (finalShipping === 0) {
                deliveryFeeElVal.innerText = "Free";
                deliveryFeeElVal.style.color = "#27ae60";
            } else {
                deliveryFeeElVal.innerText = "₹" + SHIPPING_COST;
                deliveryFeeElVal.style.color = "#666";
            }

            const discountAmount = subTotal * DISCOUNT_PERCENTAGE;
            const discountedSubTotal = subTotal - discountAmount;
            
            // Store final total for payment logic
            currentTotalValue = discountedSubTotal + finalShipping;

            grandTotalEl.innerText = formatCurrency(currentTotalValue);
            discountNoteEl.innerText = `(Includes ${formatCurrency(discountAmount)} Discount @ 12.5%)`;
            
            checkAddress();
        }

        function updateQty(index, change) {
            let cart = JSON.parse(localStorage.getItem('fawazCart')) || [];
            cart[index].quantity += change;
            if (cart[index].quantity <= 0) cart.splice(index, 1);
            localStorage.setItem('fawazCart', JSON.stringify(cart));
            loadCheckout();
        }

        function checkAddress() {
            const storedAddr = localStorage.getItem('fawazAddress');
            const mainBtn = document.getElementById('mainActionBtn');
            const upiBtn = document.getElementById('upiActionBtn');
            const addrCard = document.getElementById('savedAddressCard');

            if (storedAddr) {
                savedAddress = JSON.parse(storedAddr);
                addrCard.style.display = 'block';
                document.getElementById('dispName').innerText = savedAddress.name;
                document.getElementById('dispAddr').innerText = `${savedAddress.line1}, ${savedAddress.line2}, ${savedAddress.city} - ${savedAddress.pincode}`;
                document.getElementById('dispPhone').innerText = `Phone: ${savedAddress.phone}`;

                // Update Buttons
                mainBtn.innerText = "Place Order on WhatsApp (COD)";
                mainBtn.style.backgroundColor = "#25D366"; // WhatsApp Green
                
                // Show UPI Button
                upiBtn.style.display = "block";
            } else {
                addrCard.style.display = 'none';
                mainBtn.innerText = "Add Address";
                mainBtn.style.backgroundColor = "#A68B6C"; // Brand Brown
                
                // Hide UPI Button
                upiBtn.style.display = "none";
            }
        }

        function handleMainAction() {
            if (savedAddress) {
                placeOrderWhatsApp();
            } else {
                window.location.href = 'address.html';
            }
        }

        // --- PAYMENT LOGIC ---
        function handleUPIPayment() {
            if (!savedAddress) {
                alert("Please add an address first.");
                return;
            }
            
            // Construct UPI Link
            // am = Amount, pa = Payee Address, pn = Payee Name, cu = Currency
            const upiLink = `upi://pay?pa=${MERCHANT_UPI_ID}&pn=${MERCHANT_NAME}&am=${currentTotalValue.toFixed(2)}&cu=INR`;
            
            // Open Link
            window.location.href = upiLink;
            
            // NOTE: After payment, user usually needs to confirm.
            // Since this is static, we can redirect them to WhatsApp to send screenshot
            setTimeout(() => {
                const confirm = confirm("After paying, please share the screenshot on WhatsApp to confirm your order.");
                if(confirm) placeOrderWhatsApp(true);
            }, 3000);
        }

        function placeOrderWhatsApp(isPaid = false) {
            let cart = JSON.parse(localStorage.getItem('fawazCart')) || [];
            let message = `Hello Fawaz Fragrance, I want to place an order:%0A%0A`;
            
            cart.forEach(item => {
                message += `- ${item.name} (x${item.quantity})%0A`;
            });

            const totalText = document.getElementById('grandTotal').innerText;
            message += `%0A*Total: ${totalText}*`;
            
            if(isPaid) {
                message += `%0A*PAYMENT STATUS: PAID via UPI*`;
            } else {
                message += `%0A*PAYMENT STATUS: COD*`;
            }

            message += `%0A%0A*Delivering to:*%0A${savedAddress.name}%0A${savedAddress.line1}, ${savedAddress.line2}, ${savedAddress.city} - ${savedAddress.pincode}%0APhone: ${savedAddress.phone}`;

            const phoneNumber = "919004263544"; 
            window.open(`https://wa.me/${phoneNumber}?text=${message}`, '_blank');
        }

        document.addEventListener('DOMContentLoaded', loadCheckout);
    </script>
</body>
</html>
